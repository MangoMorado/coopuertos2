[phases]

[phases.setup]
# Usamos apt para Node (aunque Nixpacks ya lo incluye), pero es bueno para dependencias.
apt = ["git", "unzip"] 
cmds = [
    "mkdir -p public/uploads/{carnets,conductores,pqrs,vehiculos}"
]

[phases.build]
cmds = [
    # ----------------------------------------
    # I. Dependencias y Compilación de Assets
    # ----------------------------------------
    "composer install --no-dev --optimize-autoloader", # ¡La única instalación de Composer!
    "npm install",                                   # Instala las dependencias de Node.js
    "npm run build",                                 # Genera public/build/manifest.json

    # ----------------------------------------
    # II. Base de Datos y Configuración
    # ----------------------------------------
    "php artisan migrate --force", 
    # Aquí puedes añadir otros comandos de configuración, como:
    # "php artisan config:cache", 
    # "php artisan route:cache",

    # ----------------------------------------
    # III. Permisos y Enlaces (Storage)
    # ----------------------------------------
    "chmod -R 775 storage bootstrap/cache",
    "chmod -R 775 public/uploads",
    "php artisan storage:link"
]