# Configuración completa de Nixpacks para Coopuertos

[phases.setup]
nixPkgs = [
    "php82",
    "php82Extensions.imagick",
    "nginx",
    "libmysqlclient",
    "phpPackages.composer",
    "nodejs_22",
    "imagemagick",
    "python312Packages.supervisor",
]

[phases.install]
cmds = [
    "mkdir -p /var/log/nginx",
    "mkdir -p /var/cache/nginx",
    "composer install --ignore-platform-reqs",
    "npm ci",
]

[phases.build]
cmds = [
    "npm run build",
    "chmod -R 775 storage bootstrap/cache public/uploads",
    "php artisan storage:link || true",
    "echo '=== Verificación de Imagick ==='",
    "php -m | grep -i imagick && echo '✓ Imagick está instalado' || echo '✗ Imagick NO está instalado'",
    "php --ri imagick 2>/dev/null || echo '⚠️ Imagick no está habilitado en PHP'",
    "echo 'Buscando imagick.so en el sistema...'",
    "find /nix/store -name 'imagick.so' 2>/dev/null | head -3 || echo 'No se encontró imagick.so'",
    "echo 'Ruta de PHP:'",
    "which php || echo 'PHP no encontrado en PATH'",
    "echo 'Información de PHP:'",
    "php --version || echo 'Error al obtener versión de PHP'",
]

[start]
cmd = "chmod -R 775 /app/storage /app/bootstrap/cache && chmod -R 777 /app/public/uploads && php /app/artisan storage:setup-directories && chmod -R 777 /app/public/uploads/conductores /app/public/uploads/vehiculos /app/public/uploads/pqrs /app/public/uploads/carnets 2>/dev/null || true && (php /app/artisan storage:link || true) && (supervisord -c /etc/supervisor/supervisord.conf &) && node /assets/scripts/prestart.mjs /assets/nginx.template.conf /nginx.conf && (php-fpm -y /assets/php-fpm.conf & nginx -c /nginx.conf)"
