[phases]

# 1. Fase de Configuración (Setup)
[phases.setup]
apt = ["git", "unzip"]
cmds = [
    # Crea los directorios ignorados por Git
    "mkdir -p public/uploads/{carnets,conductores,pqrs,vehiculos}"
]

# 2. Fase de Construcción (Build)
[phases.build]
cmds = [
    # ----------------------------------------
    # I. Dependencias y Compilación de Assets
    # ----------------------------------------
    "composer install --no-dev --optimize-autoloader", # Instala dependencias de PHP (solo producción)
    "npm install",
    "npm run build", # Genera public/build/manifest.json

    # ----------------------------------------
    # II. Base de Datos y Configuración
    # ----------------------------------------
    # Ejecuta las migraciones de la base de datos.
    # --force es necesario en entornos de producción.
    "php artisan migrate --force", 
    
    # OPCIONAL: Si necesitas seeders (solo si son necesarios para el deploy)
    # "php artisan db:seed --force", 

    # ----------------------------------------
    # III. Permisos y Enlaces (Storage)
    # ----------------------------------------
    "chmod -R 775 storage bootstrap/cache",
    "chmod -R 775 public/uploads",
    "php artisan storage:link"
]