# Configuración completa de Nixpacks para Coopuertos
# Configuración manual para evitar detección automática que genera npm-9_x
# Incluye todos los paquetes necesarios: PHP, Node.js, Nginx, MySQL, ImageMagick

[phases.setup]
# Paquetes Nix - npm viene incluido con nodejs_18, no se especifica por separado
# php82 con extensión imagick usando la sintaxis correcta de Nixpacks
nixPkgs = [
    "php82",
    "php82Extensions.imagick",
    "nginx",
    "libmysqlclient",
    "phpPackages.composer",
    "nodejs_18",
    "imagemagick",
]

# Extensión de PHP Imagick se configura a través de php82Extensions
# Los paquetes APT (imagemagick php-imagick) se instalan en la fase install si es necesario

[phases.install]
cmds = [
    "mkdir -p /var/log/nginx",
    "mkdir -p /var/cache/nginx",
    "composer install --ignore-platform-reqs",
    "npm ci",
]

[phases.build]
cmds = [
    "npm run build",
    "chmod -R 775 storage bootstrap/cache public/uploads",
    "php artisan storage:link",
]

[start]
cmd = "chmod -R 775 /app/storage /app/bootstrap/cache /app/public/uploads && php /app/artisan storage:setup-directories && php /app/artisan storage:link && php-fpm"
